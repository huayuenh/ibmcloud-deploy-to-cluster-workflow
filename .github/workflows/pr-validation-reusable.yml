name: PR Validation (Reusable)

on:
  workflow_call:
    inputs:
      run-unit-tests:
        description: 'Run unit tests'
        required: false
        type: boolean
        default: true
      
      build-image:
        description: 'Build Docker image'
        required: false
        type: boolean
        default: true
      
      push-to-registry:
        description: 'Push image to registry for scanning'
        required: false
        type: boolean
        default: true
      
      scan-image:
        description: 'Scan image for vulnerabilities'
        required: false
        type: boolean
        default: true
      
      delete-after-scan:
        description: 'Delete PR image after scanning'
        required: false
        type: boolean
        default: true
    
    secrets:
      ibmcloud-apikey:
        description: 'IBM Cloud API key'
        required: true
    
    outputs:
      image-name:
        description: 'Built image name'
        value: ${{ jobs.build.outputs.image-name }}
      
      scan-result:
        description: 'Vulnerability scan result'
        value: ${{ jobs.build.outputs.scan-result }}
      
      test-result:
        description: 'Unit test result'
        value: ${{ jobs.test.outputs.result }}

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    if: inputs.run-unit-tests
    outputs:
      result: ${{ steps.test.outcome }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set commit status - pending
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "pending"
          description: "Running tests"
          context: "PR Validation / Unit Tests"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}
      
      - name: Run unit tests
        id: test
        run: |
          npm install
          npm run test-unit
      
      - name: Set commit status - success
        if: success()
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "success"
          description: "Tests passed"
          context: "PR Validation / Unit Tests"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}
      
      - name: Set commit status - failure
        if: failure()
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "failure"
          description: "Tests failed"
          context: "PR Validation / Unit Tests"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}

  build:
    name: Build and Scan Image
    runs-on: ubuntu-latest
    needs: test
    if: always() && inputs.build-image
    outputs:
      image-name: ${{ steps.build.outputs.image-name }}
      scan-result: ${{ steps.push.outputs.scan-result }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set commit status - pending
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "pending"
          description: "Building image"
          context: "PR Validation / Build"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}
      
      - name: Build Docker image
        id: build
        uses: huayuenh/docker-container-build-action@main
        with:
          context: .
          dockerfile: Dockerfile
          tag: pr-${{ github.event.pull_request.number }}-${{ github.sha }}
          build-args: |
            BUILD_DATE=${{ github.event.pull_request.updated_at }}
            COMMIT_SHA=${{ github.sha }}
          labels: |
            org.opencontainers.image.created=${{ github.event.pull_request.updated_at }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repositoryUrl }}
          no-cache: false
          pull: true
      
      - name: Push to registry for scanning
        id: push
        if: inputs.push-to-registry
        uses: huayuenh/container-registry-service-action@main
        with:
          apikey: ${{ secrets.ibmcloud-apikey }}
          image: ${{ vars.ICR_REGION }}/${{ vars.ICR_NAMESPACE }}/${{ steps.build.outputs.image-name }}
          local-image: ${{ steps.build.outputs.image-name }}
          action: push
          scan: ${{ inputs.scan-image }}
          region: ${{ vars.IBMCLOUD_REGION }}
      
      - name: Set commit status - success
        if: success()
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "success"
          description: "Build successful"
          context: "PR Validation / Build"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}
      
      - name: Set commit status - failure
        if: failure()
        uses: huayuenh/set-commit-status-common-action@main
        with:
          github_token: ${{ github.token }}
          state: "failure"
          description: "Build failed"
          context: "PR Validation / Build"
          sha: ${{ github.event.pull_request.head.sha }}
          target_url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github_repository: ${{ github.repository }}

  cleanup:
    name: Cleanup PR Image
    runs-on: ubuntu-latest
    needs: build
    if: always() && inputs.delete-after-scan && inputs.push-to-registry
    
    steps:
      - name: Delete PR image from registry
        uses: huayuenh/container-registry-service-action@main
        with:
          apikey: ${{ secrets.ibmcloud-apikey }}
          image: ${{ vars.ICR_REGION }}/${{ vars.ICR_NAMESPACE }}/${{ needs.build.outputs.image-name }}
          action: delete
          region: ${{ vars.IBMCLOUD_REGION }}

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [test, build]
    if: always()
    
    steps:
      - name: Generate PR summary
        run: |
          echo "### PR Validation Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Test Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ **Unit Tests:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" == "failure" ]; then
            echo "❌ **Unit Tests:** Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" == "skipped" ]; then
            echo "⏭️ **Unit Tests:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Build Results" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "✅ **Image Build:** Successful" >> $GITHUB_STEP_SUMMARY
            echo "**Image:** \`${{ needs.build.outputs.image-name }}\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "❌ **Image Build:** Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "skipped" ]; then
            echo "⏭️ **Image Build:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "#### Pull Request Information" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.head_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            echo "### ✅ All checks passed! PR is ready for review." >> $GITHUB_STEP_SUMMARY
          else
            echo "### ⚠️ Some checks failed. Please review the errors above." >> $GITHUB_STEP_SUMMARY
          fi

# Made with Bob
